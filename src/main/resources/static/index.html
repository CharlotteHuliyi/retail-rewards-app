<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Rewards Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; }
        .table { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="card shadow p-4 mx-auto" style="max-width: 500px;">
        <h2 class="text-center text-primary mb-4">Rewards Calculator</h2>

        <div class="alert alert-info py-2 small">
            <strong>Available Test IDs:</strong> 1001, 1002, 1003
        </div>

        <div class="input-group mb-3">
            <input type="number" id="customerId" class="form-control" placeholder="Enter Customer ID" aria-label="Customer ID">
            <button class="btn btn-primary" onclick="getRewards()">Calculate</button>
        </div>

        <div id="message" class="mt-3"></div>

        <div id="resultTable" style="display: none;" class="mt-4">
            <h5 class="border-bottom pb-2">Result for ID: <span id="displayId" class="text-primary"></span></h5>
            <table class="table table-hover">
                <thead class="table-light">
                <tr>
                    <th>Month</th>
                    <th>Points Earned</th>
                </tr>
                </thead>
                <tbody id="rewardRows">
                </tbody>
                <tfoot class="table-primary fw-bold">
                <tr>
                    <td>Total Rewards</td>
                    <td id="totalPoints"></td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>
    async function getRewards() {
        const idInput = document.getElementById('customerId');
        const id = idInput.value.trim();
        const msgDiv = document.getElementById('message');
        const table = document.getElementById('resultTable');
        const rewardRows = document.getElementById('rewardRows');

        // 1. Reset UI
        msgDiv.innerHTML = "";
        table.style.display = "none";
        rewardRows.innerHTML = "";

        if (!id) {
            msgDiv.innerHTML = `<div class="alert alert-warning">Please enter a valid Customer ID.</div>`;
            return;
        }

        try {
            // 2. Fetch data using relative path
            const response = await fetch(`/rewards/${id}`);

            // 3. Handle 404/CustomerNotFound
            if (!response.ok) {
                msgDiv.innerHTML = `<div class="alert alert-danger">Customer ID <strong>${id}</strong> not found.</div>`;
                return;
            }

            const data = await response.json();
            console.log("Response from Server:", data); // Helpful for debugging

            // 4. Populate Table
            // Note: We use data.pointsPerMonth to match the RewardService.java Map name
            document.getElementById('displayId').innerText = id;

            // Map the Java HashMap keys and values to table rows
            const rows = Object.entries(data.pointsPerMonth).map(([month, pts]) => {
                return `<tr>
                            <td>${month}</td>
                            <td>${pts} pts</td>
                        </tr>`;
            }).join('');

            rewardRows.innerHTML = rows;
            document.getElementById('totalPoints').innerText = data.totalPoints + " pts";

            // 5. Show Table
            table.style.display = "block";

        } catch (err) {
            console.error("Frontend Logic Error:", err);
            msgDiv.innerHTML = `<div class="alert alert-warning">
                <strong>Connection Error:</strong> Could not reach the server or process data.
                <br><small>${err.message}</small>
            </div>`;
        }
    }

    // Allow pressing "Enter" key to submit
    document.getElementById('customerId').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            getRewards();
        }
    });
</script>

</body>
</html>